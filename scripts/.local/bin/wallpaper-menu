#!/usr/bin/env bash
set -euo pipefail

# wallpaper-menu
# Scans ~/Pictures/wallpapers (recursive) and presents a wofi menu to select one.

WALLPAPER_ROOT="$HOME/Pictures/wallpapers"
WOFI_CMD="$(command -v wofi || true)"

if [ -z "$WOFI_CMD" ]; then
    echo "Error: wofi not found." >&2
    exit 2
fi

# Generate list of images (jpg, png, gif), relative to WALLPAPER_ROOT for display
# We use 'find' to get all files, then 'sed' to make paths relative for the menu
mapfile -t IMAGE_LIST < <(find "$WALLPAPER_ROOT" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) | sed "s|$WALLPAPER_ROOT/||" | sort)

if [ ${#IMAGE_LIST[@]} -eq 0 ]; then
    notify-send "Wallpaper Menu" "No wallpapers found in $WALLPAPER_ROOT"
    exit 1
fi

# Show menu
CHOICE=$(printf "%s\n" "${IMAGE_LIST[@]}" | "$WOFI_CMD" --dmenu --prompt "Select Wallpaper" --width 600 --height 400 --cache-file /dev/null)

if [ -z "$CHOICE" ]; then
    echo "No selection made."
    exit 0
fi

FULL_PATH="$WALLPAPER_ROOT/$CHOICE"

if [ -f "$FULL_PATH" ]; then
    echo "Selected: $FULL_PATH"
    # Call the central set-wallpaper script
    "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/set-wallpaper" "$FULL_PATH"
else
    echo "Error: File not found: $FULL_PATH"
    exit 1
fi
