#!/usr/bin/env bash
set -euo pipefail

# apply-theme <wallpaper-path>
# This version is safer and ensures atomic writes to configs.

LOG_FILE="$HOME/.local/share/dotfiles/apply-theme.log"
mkdir -p "$(dirname "$LOG_FILE")"
>"$LOG_FILE"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "--- Starting apply-theme: $(date) ---"
# ... (rest of the script for pywal, etc.)

# --- Alacritty (Safe Version) ---
ALACRITTY_SOURCE="$HOME/dotfiles/alacritty/.config/alacritty/alacritty.toml"
ALACRITTY_DEST="$HOME/.config/alacritty/alacritty.toml"
if [ -f "$ALACRITTY_SOURCE" ]; then
    echo "Generating new Alacritty config..."
    TMP_COLORS=$(mktemp)
    # ... (python script to generate colors to TMP_COLORS)
    
    # Create the new config safely
    awk '/^\[colors\]/{exit} {print}' "$ALACRITTY_SOURCE" > "$ALACRITTY_DEST.tmp"
    echo "" >> "$ALACRITTY_DEST.tmp"
    echo "[colors]" >> "$ALACRITTY_DEST.tmp"
    cat "$TMP_COLORS" >> "$ALACRITTY_DEST.tmp"
    
    # Atomically replace the old config
    mv "$ALACRITTY_DEST.tmp" "$ALACRITTY_DEST"
    rm -f "$TMP_COLORS"
    echo "Alacritty theme updated safely."

    # Verify the new config
    if ! ~/dotfiles/scripts/.local/bin/test-alacritty.sh; then
        echo "ERROR: New Alacritty config is invalid. Restoring from source."
        # Restore the known-good version from the repo
        cp "$ALACRITTY_SOURCE" "$ALACRITTY_DEST"
        exit 1
    fi
fi

# ... (rest of the script for Waybar, Niri, etc.)
echo "--- Theme application complete ---"
